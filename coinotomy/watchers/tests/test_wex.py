import unittest
import logging

from coinotomy.backend.ramdiskbackend import RamdiskStorageBackend
from coinotomy.watchers.wex import WatcherBtce, BtceAPI

log = logging.getLogger("dummy")


def is_sorted(trades):
    return all(a[0] <= b[0] for a, b in zip(trades[:-1], trades[1:]))


class TestWatcherBtce(unittest.TestCase):

    # an actual response of 150 trades
    RESPONSE_1 = '[{"date":1463920346,"price":442.7,"amount":0.121677,"tid":69999074,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463920346,"price":442.7,"amount":0.077803,"tid":69999073,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463920334,"price":442.7,"amount":0.00810699,"tid":69999068,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463920334,"price":442.7,"amount":0.08539,"tid":69999067,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463920334,"price":442.7,"amount":0.042173,"tid":69999066,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463920334,"price":442.701,"amount":0.125,"tid":69999065,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463920321,"price":442.7,"amount":0.014877,"tid":69999062,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463920321,"price":442.7,"amount":0.04023,"tid":69999061,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463920321,"price":442.7,"amount":0.010533,"tid":69999060,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463920321,"price":442.701,"amount":0.01725,"tid":69999059,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463920310,"price":442.701,"amount":0.28275,"tid":69999052,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463920302,"price":442.7,"amount":0.08738,"tid":69999050,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463920301,"price":442.7,"amount":0.07,"tid":69999049,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463920294,"price":443,"amount":7.95201,"tid":69999047,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463920294,"price":442.999,"amount":2.234,"tid":69999046,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463920294,"price":442.901,"amount":0.3,"tid":69999045,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463920294,"price":442.701,"amount":4.51399,"tid":69999044,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463920202,"price":442.701,"amount":0.441828,"tid":69999023,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463920202,"price":442.701,"amount":0.208171,"tid":69999022,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463920192,"price":442.7,"amount":0.3,"tid":69999020,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463920192,"price":442.5,"amount":1.3999,"tid":69999019,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463920187,"price":442.5,"amount":0.03491,"tid":69999017,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463920166,"price":442.5,"amount":0.17,"tid":69999011,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463920149,"price":442.5,"amount":0.45,"tid":69999008,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463920145,"price":442.5,"amount":1,"tid":69999007,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463920139,"price":442.5,"amount":1.3,"tid":69999002,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463920127,"price":442.5,"amount":1.99792,"tid":69998999,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463920090,"price":442.5,"amount":0.1358,"tid":69998987,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463920085,"price":442.5,"amount":1,"tid":69998986,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463920071,"price":442.5,"amount":0.02,"tid":69998983,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463920000,"price":442.5,"amount":0.1,"tid":69998958,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919963,"price":442.5,"amount":0.9,"tid":69998945,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919923,"price":442.5,"amount":0.01,"tid":69998935,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919903,"price":442.5,"amount":1,"tid":69998927,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919875,"price":442.5,"amount":0.01,"tid":69998919,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919872,"price":442.5,"amount":0.01,"tid":69998918,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919869,"price":442.5,"amount":0.01,"tid":69998917,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919865,"price":442.5,"amount":0.0036762,"tid":69998915,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919865,"price":442.499,"amount":0.0063238,"tid":69998914,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919857,"price":442.499,"amount":0.01,"tid":69998912,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919850,"price":442.499,"amount":0.01,"tid":69998910,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919843,"price":442.499,"amount":0.01,"tid":69998908,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919838,"price":442.499,"amount":0.01,"tid":69998903,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919833,"price":442.499,"amount":0.01,"tid":69998901,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919829,"price":442.499,"amount":0.01,"tid":69998899,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919825,"price":442.5,"amount":0.01,"tid":69998898,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919821,"price":442.499,"amount":0.01,"tid":69998897,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919818,"price":442.499,"amount":0.01,"tid":69998895,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919814,"price":442.499,"amount":0.01,"tid":69998894,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919810,"price":442.5,"amount":0.01,"tid":69998889,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919807,"price":442.499,"amount":0.01,"tid":69998888,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919800,"price":442.499,"amount":0.01,"tid":69998886,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919796,"price":442.5,"amount":0.01,"tid":69998885,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919791,"price":442.499,"amount":0.01,"tid":69998883,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919787,"price":442.499,"amount":0.01,"tid":69998882,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919783,"price":442.5,"amount":0.01,"tid":69998881,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919779,"price":442.499,"amount":0.01,"tid":69998879,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919776,"price":442.499,"amount":0.01,"tid":69998878,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919773,"price":442.499,"amount":0.01,"tid":69998876,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919769,"price":442.5,"amount":0.01,"tid":69998875,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919765,"price":442.499,"amount":0.01,"tid":69998874,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919761,"price":442.499,"amount":0.01,"tid":69998869,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919749,"price":442.499,"amount":0.01,"tid":69998868,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919744,"price":442.5,"amount":0.01,"tid":69998866,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919740,"price":442.499,"amount":0.01,"tid":69998865,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919736,"price":442.499,"amount":0.01,"tid":69998863,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919732,"price":442.499,"amount":0.01,"tid":69998862,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919715,"price":442.5,"amount":0.01,"tid":69998859,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919709,"price":442.499,"amount":0.01,"tid":69998857,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919703,"price":442.499,"amount":0.01,"tid":69998855,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919696,"price":442.499,"amount":0.01,"tid":69998850,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919690,"price":442.499,"amount":0.01,"tid":69998848,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919685,"price":442.5,"amount":0.01,"tid":69998847,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919680,"price":442.499,"amount":0.01,"tid":69998842,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919672,"price":442.499,"amount":0.01,"tid":69998837,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919667,"price":442.499,"amount":0.01,"tid":69998836,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919663,"price":442.499,"amount":0.0536762,"tid":69998831,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919663,"price":442,"amount":3.6614,"tid":69998830,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919663,"price":442,"amount":0.01,"tid":69998829,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919658,"price":441.95,"amount":0.04,"tid":69998827,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463919658,"price":441.951,"amount":0.06,"tid":69998826,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463919643,"price":442.5,"amount":0.01,"tid":69998820,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919638,"price":442.499,"amount":0.01,"tid":69998819,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919633,"price":442.499,"amount":0.01,"tid":69998816,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919628,"price":442.5,"amount":0.01,"tid":69998815,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919625,"price":442.5,"amount":0.01,"tid":69998814,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919620,"price":442.7,"amount":0.01,"tid":69998809,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919615,"price":442.7,"amount":0.01,"tid":69998808,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919610,"price":442.7,"amount":0.01,"tid":69998804,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919605,"price":442.7,"amount":0.01,"tid":69998803,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919599,"price":442.701,"amount":0.01,"tid":69998801,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919591,"price":442.701,"amount":0.00307462,"tid":69998796,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919591,"price":442.7,"amount":0.00692538,"tid":69998795,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919587,"price":442.7,"amount":0.118075,"tid":69998794,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463919582,"price":442.701,"amount":0.01,"tid":69998792,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919580,"price":442.701,"amount":0.125,"tid":69998791,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463919547,"price":442.7,"amount":0.497365,"tid":69998779,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463919547,"price":442.7,"amount":0.05944,"tid":69998778,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463919547,"price":442.7,"amount":0.0978,"tid":69998777,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463919547,"price":442.7,"amount":0.27192,"tid":69998776,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463919547,"price":442.7,"amount":0.25951,"tid":69998775,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463919547,"price":442.7,"amount":0.21998,"tid":69998774,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463919547,"price":442.7,"amount":0.0829,"tid":69998773,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463919547,"price":442.701,"amount":0.0261846,"tid":69998772,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463919542,"price":442.701,"amount":0.0172754,"tid":69998770,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463919520,"price":442.701,"amount":0.09189,"tid":69998764,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463919516,"price":442.7,"amount":0.09301,"tid":69998762,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463919506,"price":443,"amount":1.06571,"tid":69998760,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919506,"price":442.8,"amount":0.93929,"tid":69998759,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919498,"price":442.701,"amount":0.21946,"tid":69998758,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463919493,"price":442.701,"amount":0.06459,"tid":69998756,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463919488,"price":442.701,"amount":0.2806,"tid":69998754,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463919360,"price":443,"amount":18.4916,"tid":69998734,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919360,"price":442.89,"amount":0.4,"tid":69998733,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919360,"price":442.7,"amount":0.3,"tid":69998732,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919360,"price":442.5,"amount":0.49708,"tid":69998731,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919360,"price":442.499,"amount":0.3,"tid":69998730,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919360,"price":442.3,"amount":0.0113071,"tid":69998729,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919342,"price":442.5,"amount":2.49742,"tid":69998728,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463919342,"price":442.501,"amount":0.3,"tid":69998727,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463919248,"price":442.5,"amount":0.414588,"tid":69998720,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463919248,"price":442.501,"amount":0.3,"tid":69998719,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463919244,"price":443,"amount":0.073794,"tid":69998718,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919239,"price":443,"amount":0.201402,"tid":69998717,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919224,"price":443,"amount":0.7,"tid":69998707,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919224,"price":442.86,"amount":0.3,"tid":69998706,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919218,"price":443,"amount":0.19686,"tid":69998704,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919218,"price":442.999,"amount":0.0974097,"tid":69998703,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919218,"price":442.9,"amount":0.46,"tid":69998702,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919218,"price":442.72,"amount":0.08466,"tid":69998701,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919218,"price":442.71,"amount":0.05817,"tid":69998700,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919218,"price":442.69,"amount":0.03611,"tid":69998699,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919218,"price":442.69,"amount":0.18771,"tid":69998698,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919218,"price":442.67,"amount":0.05218,"tid":69998697,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919218,"price":442.66,"amount":0.0269,"tid":69998696,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919201,"price":442.5,"amount":0.0779705,"tid":69998693,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919201,"price":442.5,"amount":0.510022,"tid":69998692,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919158,"price":442.5,"amount":2,"tid":69998676,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919035,"price":442.5,"amount":0.0372565,"tid":69998631,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919035,"price":442.499,"amount":0.0320549,"tid":69998630,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463919035,"price":442.498,"amount":0.165989,"tid":69998629,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463918917,"price":442.5,"amount":3.50458,"tid":69998592,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463918917,"price":442.44,"amount":0.49542,"tid":69998591,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463918885,"price":442.21,"amount":0.15689,"tid":69998569,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463918885,"price":442.36,"amount":0.1203,"tid":69998568,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463918885,"price":442.41,"amount":0.02731,"tid":69998567,"price_currency":"USD","item":"BTC","trade_type":"ask"},{"date":1463918842,"price":442.5,"amount":0.07948,"tid":69998554,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463918795,"price":442.64,"amount":0.147446,"tid":69998540,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463918687,"price":442.64,"amount":1.37998,"tid":69998512,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463918687,"price":442.53,"amount":0.513766,"tid":69998511,"price_currency":"USD","item":"BTC","trade_type":"bid"}]'

    # an actual response of 4 trades
    RESPONSE_2 = '[{"date":1463918842,"price":442.5,"amount":0.07948,"tid":69998554,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463918795,"price":442.64,"amount":0.147446,"tid":69998540,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463918687,"price":442.64,"amount":1.37998,"tid":69998512,"price_currency":"USD","item":"BTC","trade_type":"bid"},{"date":1463918687,"price":442.53,"amount":0.513766,"tid":69998511,"price_currency":"USD","item":"BTC","trade_type":"bid"}]'
    RESPONSE_2_EXPECTED = [(1463918687.0, 442.53, 0.513766), (1463918687.0, 442.64, 1.37998), (1463918795.0, 442.64, 0.147446), (1463918842.0, 442.5, 0.07948)]

    def setUp(self):
        self.backend = RamdiskStorageBackend()
        self.watcher = WatcherBtce("btc_usd", "btc_usd")
        self.api = BtceAPI("btc_usd", log)

    def tearDown(self):
        del self.api

    def test_network(self):
        trades, newest_tid = self.api.more()
        self.assertEqual(len(trades), 2000)
        self.assertIsInstance(newest_tid, int)

    def test_parse_large_response(self):
        trades, newest_tid = self.api._parse_response(self.RESPONSE_1)
        self.assertEqual(newest_tid, 69999074)
        for row in trades:
            self.assertIsInstance(row[0], float)
            self.assertIsInstance(row[1], float)
            self.assertIsInstance(row[2], float)
        self.assert_(is_sorted(trades))
        self.assertEqual(len(trades), 150)

    def test_parse_small_response(self):
        trades, newest_tid = self.api._parse_response(self.RESPONSE_2)
        self.assertEqual(newest_tid, 69998554)
        self.assertEqual(trades, self.RESPONSE_2_EXPECTED)
