import unittest
import logging

from coinotomy.backend.ramdiskbackend import RamdiskStorageBackend
from coinotomy.watchers.wex import WexAPI, WatcherWex

log = logging.getLogger("dummy")


def is_sorted(trades):
    return all(a[0] <= b[0] for a, b in zip(trades[:-1], trades[1:]))


class TestWatcherWex(unittest.TestCase):

    # an actual response of 150 trades
    RESPONSE_1 = '{"btc_usd":[{"type":"ask","price":7757.485,"amount":0.04471845,"tid":27246473,"timestamp":1527761574},{"type":"ask","price":7744.979,"amount":0.00093614,"tid":27246445,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246444,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246443,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246442,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246441,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246440,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246439,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246438,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246437,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246436,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246435,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246434,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246433,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246432,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246431,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246430,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246429,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246428,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246427,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246426,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246425,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246424,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246423,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246422,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246421,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246420,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246419,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246418,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246417,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246416,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246415,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246414,"timestamp":1527761543},{"type":"bid","price":7769.99,"amount":0.03069414,"tid":27246380,"timestamp":1527761479},{"type":"ask","price":7757.485,"amount":0.23761847,"tid":27246352,"timestamp":1527761453},{"type":"bid","price":7769.99,"amount":0.038491,"tid":27246348,"timestamp":1527761441},{"type":"ask","price":7757.485,"amount":0.30685713,"tid":27246347,"timestamp":1527761441},{"type":"bid","price":7769.99,"amount":0.0216,"tid":27246340,"timestamp":1527761431},{"type":"bid","price":7770,"amount":0.00592611,"tid":27246287,"timestamp":1527761416},{"type":"bid","price":7769,"amount":0.00396191,"tid":27246286,"timestamp":1527761416},{"type":"ask","price":7757.489,"amount":0.55784029,"tid":27246234,"timestamp":1527761366},{"type":"ask","price":7757.489,"amount":0.49143814,"tid":27246221,"timestamp":1527761350},{"type":"ask","price":7744.979,"amount":0.00007533,"tid":27246217,"timestamp":1527761340},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246216,"timestamp":1527761340},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246215,"timestamp":1527761340},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246214,"timestamp":1527761340},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246213,"timestamp":1527761340},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246212,"timestamp":1527761340},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246211,"timestamp":1527761340},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246210,"timestamp":1527761340},{"type":"ask","price":7748.091,"amount":0.00100205,"tid":27246209,"timestamp":1527761340},{"type":"ask","price":7748.091,"amount":0.00100205,"tid":27246208,"timestamp":1527761339},{"type":"ask","price":7748.091,"amount":0.00100205,"tid":27246207,"timestamp":1527761339},{"type":"ask","price":7748.091,"amount":0.00100205,"tid":27246206,"timestamp":1527761339},{"type":"ask","price":7748.091,"amount":0.00100205,"tid":27246205,"timestamp":1527761339},{"type":"ask","price":7748.091,"amount":0.00097914,"tid":27246189,"timestamp":1527761317},{"type":"ask","price":7748.091,"amount":0.00100205,"tid":27246188,"timestamp":1527761317},{"type":"ask","price":7748.091,"amount":0.00100205,"tid":27246187,"timestamp":1527761317},{"type":"ask","price":7748.091,"amount":0.00100205,"tid":27246186,"timestamp":1527761317},{"type":"bid","price":7770,"amount":0.00900901,"tid":27246185,"timestamp":1527761316},{"type":"bid","price":7748.09,"amount":0.00772201,"tid":27246182,"timestamp":1527761309},{"type":"ask","price":7748.09,"amount":0.01624519,"tid":27246180,"timestamp":1527761307},{"type":"ask","price":7748.091,"amount":0.00100205,"tid":27246179,"timestamp":1527761307},{"type":"ask","price":7748.091,"amount":0.00100205,"tid":27246178,"timestamp":1527761307},{"type":"ask","price":7748.091,"amount":0.00100205,"tid":27246177,"timestamp":1527761307},{"type":"ask","price":7748.091,"amount":0.00100205,"tid":27246176,"timestamp":1527761307},{"type":"ask","price":7748.091,"amount":0.00100205,"tid":27246175,"timestamp":1527761307},{"type":"ask","price":7748.091,"amount":0.00100205,"tid":27246174,"timestamp":1527761307},{"type":"ask","price":7748.091,"amount":0.00100205,"tid":27246173,"timestamp":1527761307},{"type":"ask","price":7748.091,"amount":0.00100205,"tid":27246172,"timestamp":1527761307},{"type":"ask","price":7748.091,"amount":0.00100205,"tid":27246171,"timestamp":1527761307},{"type":"ask","price":7748.091,"amount":0.00100205,"tid":27246170,"timestamp":1527761307},{"type":"ask","price":7748.091,"amount":0.00100205,"tid":27246169,"timestamp":1527761307},{"type":"ask","price":7748.091,"amount":0.00100205,"tid":27246168,"timestamp":1527761307},{"type":"ask","price":7748.091,"amount":0.00100205,"tid":27246167,"timestamp":1527761307},{"type":"ask","price":7748.091,"amount":0.00100205,"tid":27246166,"timestamp":1527761307},{"type":"ask","price":7748.091,"amount":0.00100205,"tid":27246165,"timestamp":1527761307},{"type":"ask","price":7748.091,"amount":0.00100205,"tid":27246164,"timestamp":1527761307},{"type":"bid","price":7770,"amount":0.00398546,"tid":27246155,"timestamp":1527761295},{"type":"bid","price":7770,"amount":0.4,"tid":27246143,"timestamp":1527761272},{"type":"ask","price":7759.045,"amount":0.25465989,"tid":27246141,"timestamp":1527761270},{"type":"bid","price":7770,"amount":0.28295047,"tid":27246134,"timestamp":1527761257},{"type":"bid","price":7748.141,"amount":0.13704953,"tid":27246133,"timestamp":1527761257},{"type":"bid","price":7748.141,"amount":0.00276943,"tid":27246130,"timestamp":1527761256},{"type":"bid","price":7748.141,"amount":0.00138427,"tid":27246113,"timestamp":1527761253},{"type":"bid","price":7748.141,"amount":0.00113875,"tid":27246106,"timestamp":1527761251},{"type":"bid","price":7748.141,"amount":0.00287878,"tid":27246101,"timestamp":1527761246},{"type":"bid","price":7748.141,"amount":0.0014938,"tid":27246099,"timestamp":1527761245},{"type":"bid","price":7748.141,"amount":0.00552525,"tid":27246092,"timestamp":1527761242},{"type":"bid","price":7748.141,"amount":0.00153091,"tid":27246089,"timestamp":1527761239},{"type":"bid","price":7748.141,"amount":0.00230916,"tid":27246087,"timestamp":1527761237},{"type":"ask","price":7748.115,"amount":0.40582599,"tid":27246082,"timestamp":1527761236},{"type":"bid","price":7748.141,"amount":0.00115807,"tid":27246077,"timestamp":1527761234},{"type":"bid","price":7748.141,"amount":0.05111173,"tid":27246074,"timestamp":1527761232},{"type":"bid","price":7748.141,"amount":0.024,"tid":27246073,"timestamp":1527761232},{"type":"bid","price":7748.141,"amount":0.16780257,"tid":27246072,"timestamp":1527761232},{"type":"bid","price":7748.141,"amount":0.10509294,"tid":27246070,"timestamp":1527761231},{"type":"ask","price":7748.09,"amount":0.00953504,"tid":27246069,"timestamp":1527761231},{"type":"ask","price":7748.091,"amount":0.00100205,"tid":27246068,"timestamp":1527761231},{"type":"ask","price":7748.091,"amount":0.00100205,"tid":27246067,"timestamp":1527761231},{"type":"bid","price":7748.141,"amount":0.05475481,"tid":27246066,"timestamp":1527761231},{"type":"bid","price":7770,"amount":0.00257,"tid":27246061,"timestamp":1527761219},{"type":"ask","price":7759.071,"amount":0.11874067,"tid":27246060,"timestamp":1527761219},{"type":"bid","price":7770,"amount":0.00257,"tid":27246055,"timestamp":1527761206},{"type":"bid","price":7770,"amount":0.00257,"tid":27246050,"timestamp":1527761195},{"type":"bid","price":7748.141,"amount":0.00505577,"tid":27246047,"timestamp":1527761193},{"type":"ask","price":7759.05,"amount":0.0035,"tid":27246045,"timestamp":1527761191},{"type":"bid","price":7770,"amount":0.00257,"tid":27246041,"timestamp":1527761184},{"type":"ask","price":7764.525,"amount":0.44578748,"tid":27246038,"timestamp":1527761178},{"type":"bid","price":7770,"amount":0.00951412,"tid":27246037,"timestamp":1527761177},{"type":"bid","price":7770,"amount":0.00903538,"tid":27246036,"timestamp":1527761172},{"type":"bid","price":7770,"amount":0.00257,"tid":27246035,"timestamp":1527761172},{"type":"bid","price":7770,"amount":0.00257,"tid":27246024,"timestamp":1527761152},{"type":"ask","price":7764.525,"amount":0.57023593,"tid":27246021,"timestamp":1527761141},{"type":"bid","price":7770,"amount":0.00257,"tid":27246019,"timestamp":1527761138},{"type":"bid","price":7770,"amount":0.00257,"tid":27246015,"timestamp":1527761128},{"type":"ask","price":7764.525,"amount":0.4464252,"tid":27246011,"timestamp":1527761120},{"type":"bid","price":7770,"amount":0.00257,"tid":27246009,"timestamp":1527761116},{"type":"bid","price":7770,"amount":0.00197474,"tid":27246001,"timestamp":1527761106},{"type":"bid","price":7770,"amount":0.00257,"tid":27245999,"timestamp":1527761105},{"type":"bid","price":7770,"amount":0.00257,"tid":27245994,"timestamp":1527761094},{"type":"bid","price":7770,"amount":0.00257,"tid":27245990,"timestamp":1527761083},{"type":"bid","price":7770,"amount":0.00257,"tid":27245980,"timestamp":1527761058},{"type":"bid","price":7770,"amount":0.00790346,"tid":27245978,"timestamp":1527761052},{"type":"bid","price":7770,"amount":0.01068305,"tid":27245974,"timestamp":1527761048},{"type":"bid","price":7770,"amount":0.00257,"tid":27245972,"timestamp":1527761045},{"type":"bid","price":7770,"amount":0.10509285,"tid":27245955,"timestamp":1527761044},{"type":"bid","price":7770,"amount":0.00315025,"tid":27245954,"timestamp":1527761040},{"type":"bid","price":7770,"amount":0.00193846,"tid":27245946,"timestamp":1527761037},{"type":"bid","price":7770,"amount":0.02077702,"tid":27245943,"timestamp":1527761037},{"type":"bid","price":7770,"amount":0.0010294,"tid":27245940,"timestamp":1527761036},{"type":"bid","price":7770,"amount":0.003683,"tid":27245938,"timestamp":1527761033},{"type":"bid","price":7770,"amount":0.00357365,"tid":27245927,"timestamp":1527761032},{"type":"bid","price":7770,"amount":0.00257,"tid":27245926,"timestamp":1527761031},{"type":"bid","price":7770,"amount":0.01678014,"tid":27245925,"timestamp":1527761030},{"type":"bid","price":7770,"amount":0.00357365,"tid":27245915,"timestamp":1527761028},{"type":"bid","price":7770,"amount":0.04670893,"tid":27245913,"timestamp":1527761026},{"type":"bid","price":7770,"amount":0.00938037,"tid":27245908,"timestamp":1527761025},{"type":"bid","price":7770,"amount":0.00113875,"tid":27245907,"timestamp":1527761024},{"type":"bid","price":7770,"amount":0.00329697,"tid":27245897,"timestamp":1527761022},{"type":"bid","price":7770,"amount":0.00257,"tid":27245896,"timestamp":1527761021},{"type":"bid","price":7770,"amount":0.0010294,"tid":27245893,"timestamp":1527761020},{"type":"bid","price":7770,"amount":0.00369712,"tid":27245886,"timestamp":1527761018},{"type":"ask","price":7759.07,"amount":0.47908232,"tid":27245885,"timestamp":1527761017},{"type":"bid","price":7770,"amount":0.00407955,"tid":27245884,"timestamp":1527761016},{"type":"bid","price":7770,"amount":0.00357365,"tid":27245875,"timestamp":1527761014},{"type":"bid","price":7770,"amount":0.00901048,"tid":27245869,"timestamp":1527761012},{"type":"bid","price":7770,"amount":0.00318762,"tid":27245867,"timestamp":1527761010},{"type":"bid","price":7770,"amount":0.02522056,"tid":27245862,"timestamp":1527761008},{"type":"bid","price":7770,"amount":0.00257,"tid":27245857,"timestamp":1527761008}]}'

    # an actual response of 4 trades
    RESPONSE_2 = '{"btc_usd":[{"type":"ask","price":7757.485,"amount":0.04471845,"tid":27246473,"timestamp":1527761574},{"type":"ask","price":7744.979,"amount":0.00093614,"tid":27246445,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246444,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246443,"timestamp":1527761543},{"type":"ask","price":7744.979,"amount":0.00100206,"tid":27246442,"timestamp":1527761543}]}'
    RESPONSE_2_EXPECTED = [(1527761543.0, 7744.979, 0.00100206),
                           (1527761543.0, 7744.979, 0.00100206),
                           (1527761543.0, 7744.979, 0.00100206),
                           (1527761543.0, 7744.979, 0.00093614),
                           (1527761574.0, 7757.485, 0.04471845)]

    def setUp(self):
        self.backend = RamdiskStorageBackend()
        self.watcher = WatcherWex("btc_usd", "btc_usd")
        self.api = WexAPI("btc_usd", log)

    def tearDown(self):
        del self.api

    def test_network(self):
        trades, newest_tid = self.api.more()
        self.assertEqual(len(trades), 5000)
        self.assertIsInstance(newest_tid, int)

    def test_parse_large_response(self):
        trades, newest_tid = self.api._parse_response(self.RESPONSE_1)
        self.assertEqual(newest_tid, 27246473)
        for row in trades:
            self.assertIsInstance(row[0], float)
            self.assertIsInstance(row[1], float)
            self.assertIsInstance(row[2], float)
        self.assert_(is_sorted(trades))
        self.assertEqual(len(trades), 150)

    def test_parse_small_response(self):
        trades, newest_tid = self.api._parse_response(self.RESPONSE_2)
        self.assertEqual(newest_tid, 27246473)
        self.assertEqual(trades, self.RESPONSE_2_EXPECTED)
